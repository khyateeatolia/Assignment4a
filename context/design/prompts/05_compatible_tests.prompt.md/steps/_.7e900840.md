---
timestamp: 'Sun Oct 19 2025 15:01:10 GMT-0400 (Eastern Daylight Time)'
parent: '[[../20251019_150110.b3b5b21c.md]]'
content_id: 7e9008409e5fb9b6d5e43b8bf2599cd4724631beca7625fd8d675b2ddb259c39
---

# Generate Compatible Tests for SSO-based UserAccount Implementation

## Role

You are a senior Deno + TypeScript + MongoDB engineer. I need you to create comprehensive tests for the SSO-based UserAccount concept implementation, following the LikertSurvey test format, and generate appropriate fake test data that are compatible with the actual implementation.

## Context

Based on your previous response for SSO-based UserAccount tests, I now have the actual implementation that was created. I need tests that work with this real implementation, not a mock.

## Current Implementation

Here is the actual UserAccount concept implementation that needs to be tested: [@](../../src/concepts/UserAccount/UserAccountConcept.ts)

## Example Test Format

I want the tests to follow the LikertSurvey format: [@](../../src/concepts/LikertSurvey/LikertSurveyConcept.test.ts)

## Implementation Details

The actual implementation includes:

### Key Features:

* **SSO Integration**: Uses `SSOValidationService` interface for external SSO validation
* **Event System**: Emits events via `EventBus` interface
* **Configuration**: Uses `UserAccountConfig` for settings
* **Session Management**: Proper session lifecycle with `isValid` flag
* **Profile Separation**: `User` and `Profile` are separate collections
* **Password Management**: Optional local password support for hybrid auth

### API Methods:

* `register_or_login(ssoProvider, ssoToken, ipAddress, userAgent) -> { userId, sessionId }`
* `logout(sessionId) -> void`
* `change_avatar(userId, newAvatar) -> void`
* `change_bio(userId, bio) -> void`
* `change_password(userId, currentPassword, newPassword) -> void`
* `delete_account(userId) -> void`
* `view_profile(userId) -> ProfileView`
* `validate_session(sessionId) -> UserId`

### Data Models:

* **User**: `_id`, `email`, `username`, `ssoProvider`, `ssoId`, `avatarUrl?`, `createdAt`, `lastLoginAt`, `isActive`, `passwordHash?`
* **Profile**: `_id`, `bio?`, `listings[]`, `bids[]`, `threads[]`
* **Session**: `_id`, `userId`, `createdAt`, `expiresAt`, `ipAddress`, `userAgent`, `isValid`
* **ProfileView**: Combined view with user and profile data

### Error Classes:

* `UserAccountError`, `AuthenticationFailedError`, `SessionNotFoundError`
* `InvalidSessionError`, `UsernameTakenError`, `UserNotFoundError`
* `InvalidCredentialsError`, `BioTooLongError`, `PasswordTooShortError`

## Test Requirements

### Test Format

* Use `Deno.test()` with descriptive names (like "Principle: User registers via SSO, logs in, manages profile, logs out")
* Follow the LikertSurvey pattern of one comprehensive test per principle
* Use `testDb()` from `@utils/database.ts` for database setup
* Use `try/finally` blocks for cleanup
* Use `assertExists`, `assertEquals`, `assertNotEquals` from `jsr:@std/assert`

### Test Principles to Cover

1. **SSO Registration and Login Flow**: First-time SSO login → Account creation → Profile setup
2. **Session Management**: Login → Session validation → Logout → Session invalidation
3. **Profile Management**: Avatar editing, bio updates, password changes
4. **Account Lifecycle**: Registration → Usage → Deletion
5. **Error Handling**: Invalid SSO tokens, expired sessions, invalid credentials
6. **Security**: Session validation, account deactivation, unauthorized access

### Mock Services Required

The implementation requires these services to be mocked:

* **`SSOValidationService`**: Mock the `validateToken()` method
* **`EventBus`**: Mock the event emission system
* **`UserAccountConfig`**: Provide configuration values

### Fake Data Requirements

Generate comprehensive fake test data including:

* **SSO Providers**: Different university SSO systems
* **SSO Tokens**: Valid and invalid tokens for testing
* **User Data**: Various user profiles with different attributes
* **Session Data**: Active and expired sessions
* **Edge Cases**: Duplicate usernames, invalid emails, etc.

## Output Format

* **Assumptions**: Any assumptions about the test approach
* **Complete test file**: Full TypeScript test file following LikertSurvey format
* **Fake test data file**: Comprehensive test data for all scenarios
* **Mock services**: Mock implementations for SSOValidationService, EventBus, and config
* **Test data usage**: How to integrate the fake test data
* **Cleanup strategy**: Database and resource cleanup approach

## Constraints

* Must use `testDb()` from `@utils/database.ts`
* Must follow the exact LikertSurvey test structure
* Must test complete workflows, not individual methods
* Must use the actual UserAccount concept implementation (not a mock)
* Must include proper error assertions
* Must handle MongoDB operations correctly
* Must test session management and SSO integration
* Must provide mock services for external dependencies

## Expected Output

A complete test file that demonstrates the SSO-based UserAccount concept through operational principles, following the LikertSurvey format exactly, along with comprehensive fake test data and mock services that work with the actual implementation.
